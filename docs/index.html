<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAOD3R - AO3 Reader</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f9; padding: 20px; }
    h1 { color: #333; }
    input, select, button { padding: 10px; font-size: 16px; margin: 5px 0; }
    button { cursor: pointer; background: #0077cc; color: white; border: none; border-radius: 5px; margin: 5px; }
    button:hover { background: #005fa3; }
    .card { background: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .chapter { white-space: pre-line; margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .back-btn { margin-bottom: 15px; display: inline-block; }
    .pagination { margin-top: 15px; }
  </style>
</head>
<body>
  <h1>ðŸ“– RAOD3R</h1>
  <div id="app"></div>

  <script>
    const API_BASE = "https://raod3r.onrender.com";

    let currentPage = 1;
    let currentTag = "";
    let currentFilters = {};

    async function renderSearch() {
      document.getElementById("app").innerHTML = `
        <div>
          <input id="tag" placeholder="Enter tag (e.g. romance)" value="${currentTag}" />
          <br/>
          <label>Fandom:</label>
          <input id="fandom" placeholder="e.g. Harry Potter" value="${currentFilters.fandom || ""}" />
          <br/>
          <label>Rating:</label>
          <select id="rating">
            <option value="">Any</option>
            <option value="General">General</option>
            <option value="Teen">Teen</option>
            <option value="Mature">Mature</option>
            <option value="Explicit">Explicit</option>
          </select>
          <br/>
          <label>
            <input type="checkbox" id="completed" ${currentFilters.completed ? "checked" : ""} />
            Completed works only
          </label>
          <br/>
          <button onclick="startSearch()">Search</button>
        </div>
        <div id="results"></div>
        <div class="pagination" id="pagination"></div>
      `;

      // Restore rating dropdown
      if (currentFilters.rating) {
        document.getElementById("rating").value = currentFilters.rating;
      }

      if (currentTag) doSearch(currentTag, currentPage, currentFilters);
    }

    function startSearch() {
      currentTag = document.getElementById("tag").value;
      currentFilters = {
        fandom: document.getElementById("fandom").value,
        rating: document.getElementById("rating").value,
        completed: document.getElementById("completed").checked
      };
      currentPage = 1;
      doSearch(currentTag, currentPage, currentFilters);
    }

    async function doSearch(tag, page, filters={}) {
      const params = new URLSearchParams();
      params.append("tag", tag);
      params.append("page", page);
      if (filters.fandom) params.append("fandom", filters.fandom);
      if (filters.rating) params.append("rating", filters.rating);
      if (filters.completed) params.append("completed", "true");

      const res = await fetch(`${API_BASE}/search?${params.toString()}`);
      const data = await res.json();

      const resultsDiv = document.getElementById("results");
      resultsDiv.innerHTML = "";

      if (!data.results || data.results.length === 0) {
        resultsDiv.innerHTML = "<p>No results found.</p>";
        return;
      }

      data.results.forEach(item => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <h2>${item.title}</h2>
          <p><b>Author:</b> ${item.author}</p>
          <p><b>Fandom:</b> ${item.fandom || "Unknown"}</p>
          <p><b>Rating:</b> ${item.rating || "Unrated"}</p>
          <p>${item.summary || "No summary available."}</p>
          <button onclick="location.hash='#/story/${item.id}'">ðŸ“– View</button>
        `;
        resultsDiv.appendChild(card);
      });

      renderPagination();
    }

    function renderPagination() {
      const paginationDiv = document.getElementById("pagination");
      paginationDiv.innerHTML = `
        ${currentPage > 1 ? `<button onclick="prevPage()">â¬… Previous</button>` : ""}
        <span> Page ${currentPage} </span>
        <button onclick="nextPage()">Next âž¡</button>
      `;
    }

    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        doSearch(currentTag, currentPage, currentFilters);
      }
    }

    function nextPage() {
      currentPage++;
      doSearch(currentTag, currentPage, currentFilters);
    }

    async function renderStory(id) {
      const res = await fetch(`${API_BASE}/story/${id}`);
      const data = await res.json();
      document.getElementById("app").innerHTML = `
        <button class="back-btn" onclick="location.hash='#/search'">â¬… Back to results</button>
        <h2>${data.title}</h2>
        <p><b>Author:</b> ${data.author}</p>
        <p><b>Fandom:</b> ${data.fandom || "Unknown"}</p>
        <p><b>Rating:</b> ${data.rating || "Unrated"}</p>
        <p>${data.summary || ""}</p>
        <h3>Chapters:</h3>
        <div id="chapters"></div>
      `;
      const chapDiv = document.getElementById("chapters");
      data.chapters.forEach((ch, i) => {
        const chap = document.createElement("div");
        chap.className = "chapter";
        chap.innerHTML = `<h4>Chapter ${i+1}</h4><p>${ch}</p>`;
        chapDiv.appendChild(chap);
      });
    }

    function router() {
      const hash = location.hash || "#/search";
      const parts = hash.split("/");
      if (parts[1] === "search") {
        renderSearch();
      } else if (parts[1] === "story" && parts[2]) {
        renderStory(parts[2]);
      } else {
        renderSearch();
      }
    }

    window.addEventListener("hashchange", router);
    window.addEventListener("load", router);
  </script>
</body>
</html>
