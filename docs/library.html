<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>RAOD3R - Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Merriweather', serif;
      background: #fafafa;
      color: #222;
      line-height: 1.6;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    nav {
      background: #222;
      color: #fff;
      padding: 10px;
      display: flex;
      justify-content: space-around;
    }

    nav a {
      color: #fff;
      text-decoration: none;
      padding: 6px 12px;
    }

    nav a.active {
      font-weight: bold;
      border-bottom: 2px solid #ff6b6b;
    }

    .category-bar {
      margin: 20px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .category-bar button {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background: #ff6b6b;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    .story-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .story-card h3 {
      margin: 0 0 8px 0;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav>
    <a href="index.html">Home</a>
    <a href="library.html" class="active">Library</a>
    <a href="reader.html">Reader</a>
  </nav>

  <!-- Category Bar -->
  <div class="category-bar">
    <button onclick="showCategory('romance')">Romance</button>
    <button onclick="showCategory('mystery')">Mystery</button>
    <button onclick="showCategory('adventure')">Adventure</button>
    <button onclick="showCategory('sci-fi')">Sci-Fi</button>
    <button onclick="showCategory('fantasy')">Fantasy</button>
  </div>

  <!-- Stories -->
  <div id="story-list">
    <p>Loading categories... please wait.</p>
  </div>

  <script>
    let categoryStories = {}; // Cache in memory
    const categories = ["romance", "mystery", "adventure", "sci-fi", "fantasy"];

    async function preloadCategories() {
      for (let cat of categories) {
        try {
          let res = await fetch(`https://raod3r-backend.onrender.com/search?tag=${cat}&limit=100`);
          if (res.ok) {
            let data = await res.json();
            categoryStories[cat] = data.results;
            saveCategoryToIndexedDB(cat, data.results);
          } else {
            // Try loading from IndexedDB if fetch fails
            categoryStories[cat] = await getCategoryFromIndexedDB(cat) || [];
          }
        } catch (e) {
          console.error("❌ Failed to load category:", cat, e);
          categoryStories[cat] = await getCategoryFromIndexedDB(cat) || [];
        }
      }
      document.getElementById("story-list").innerHTML = `<p>Select a category above.</p>`;
      console.log("✅ Categories preloaded:", Object.keys(categoryStories));
    }

    function showCategory(cat) {
      let container = document.getElementById("story-list");
      container.innerHTML = "";

      let stories = categoryStories[cat] || [];
      if (stories.length === 0) {
        container.innerHTML = `<p>No stories found in ${cat}.</p>`;
        return;
      }

      stories.forEach(story => {
        let div = document.createElement("div");
        div.className = "story-card";
        div.innerHTML = `
          <h3>${story.title}</h3>
          <p><strong>Author:</strong> ${story.author || "Unknown"}</p>
          <button onclick="openStory('${story.id}')">Read</button>
        `;
        container.appendChild(div);
      });
    }

    function openStory(storyId) {
      localStorage.setItem("currentReader", JSON.stringify({
        storyId: storyId,
        chapter: 0
      }));
      window.location.href = "reader.html";
    }

    // IndexedDB setup
    function getDB() {
      return new Promise((resolve, reject) => {
        let request = indexedDB.open("RAOD3R", 2);
        request.onupgradeneeded = e => {
          let db = e.target.result;
          if (!db.objectStoreNames.contains("categories")) {
            db.createObjectStore("categories", { keyPath: "id" });
          }
        };
        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    async function saveCategoryToIndexedDB(cat, stories) {
      let db = await getDB();
      let tx = db.transaction("categories", "readwrite");
      let store = tx.objectStore("categories");
      store.put({ id: cat, stories });
    }

    async function getCategoryFromIndexedDB(cat) {
      let db = await getDB();
      return new Promise((resolve, reject) => {
        let tx = db.transaction("categories", "readonly");
        let store = tx.objectStore("categories");
        let req = store.get(cat);
        req.onsuccess = () => resolve(req.result ? req.result.stories : null);
        req.onerror = () => reject(null);
      });
    }

    window.onload = preloadCategories;
  </script>
</body>
</html>
